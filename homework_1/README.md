# Сбор статистики по коронавирусу в России

## Задача
1. Арендовать сервер, разрешить вход по ssh ключу для оргов (ключ будет в чате).
2. Развернуть на сервере Airflow, спрятанный за basic auth.
3. Написать и выкатить DAG, который ходит в [апишку Яндекса](https://yastat.net/s3/milab/2020/covid19-stat/data/data_struct_10.json?v=timestamp), тянет оттуда данные по коронавирусу и кладет их в .csv файлик, который можно скачать.

Требования к DAG:
- Запускается каждый день в 12:00 по Москве.
- Тянет все данные до текущего момента.
- Складывает данные по России.
- Колонки в csv: date, region, infected, recovered, dead.

## Файлы
- dags/homework_1.py - код Airflow DAG для сбора статистики
- config/
  - airflow - конфигурация сервера nginx
  - airflow.cfg - конфигурация Airflow

## Описание данных 
- Для вызова данного API необходимо формировать ссылки вида  
https://yastat.net/s3/milab/2020/covid19-stat/data/data_struct_{num}.json?v=timestamp  
где num - номер файла (нумерация начинается с 1)
- Данные содержат статистику по 85 регионам РФ, начиная с даты 05.04.2020
- Данные по файлам распределены неравномерно, с пересечениями по датам, и возможными дубликатами по дате и региону в различных файлах
- Формат файла 1 отличается от формата всех последующих файлох (отличие - в формате и содержанию количественных статистик)
- Не все файлы могут иметь данные по России
- Некоторые статистики могут не иметь значений за указанный период

## Описание решения
### Создание VM 
- VM создана на платформе Google Cloud
- Настроен статический внешний ip-адрес
- Настроен доступ по SSH

### Настройка Airflow
- Timezone - установлен для Москвы по умолчанию 
- Base URL - настроен доступ к Aiflow UI по пути /airflow

### Установка и настройка nginx
- Настроены доступы к Airflow UI и к файлу с результатами
  - /airflow - Airflow UI
  - /data - файл с результата
- Настройка basic authentication для доступа к Airflow

### Создание и настройка Airflow DAG
- Получить шаблон URL для формирования ссылок на файлы
  - Добавлена возможность использовать более полную статистику
    https://yastat.net/s3/milab/2020/covid19-stat/data/deep_history_struct_{num}.json?v=1591117446
    где num - номер файла (нумерация начинается с 1)
- Получить все данные по последовательно сформированным ссылкам (начиная с файла с номером 1), учитывая следующие правила:
  - Если файл не содержит какой-то статистики за период - заполнить данные нулями за весь период
  - Если файл не содержит данные по России - пропустить файл
  - Если файла с таким номером не существует - остановить сбор данных
  - Получить только необходимые поля из данных по каждому региону
- Объединить все полученные данные
  - Добавить номер файла для дальнейшего удаления дубликатов
- Посчитать статистики по каждому региону  
  - Если есть несколько записей по дате и региону - оставить только последнюю запись (с наибольшим номером файла)
- Сохранить файл в csv-формате
