# Обработка событий в Telegram

## Задача
1. Сделать DAG из трёх шагов, использующий telegram bot API.
2. Бот публикует сообщение в групповой чат с кнопкой "Поехали" под сообщением. Вас добавят в группу. Токен будет в чате.
3. Сенсор в пайплайне ждёт когда кто-то нажмёт на кнопку под сообщением в телеге. Группа и бот общий для всех, так что не стесняйтесь помогать тестировать друг другу.
4. Распарсите нужный апдейт от бота. Сохраните метаданные в таблицу в airtable. [Документация по доступам](https://github.com/python-jitsu/airflow101/blob/master/img/w3-airtable-access.png) (картинка, 4 Mb).
5. Вы можете сделать DAG без расписания и триггерить его руками из админки.

Технические (и не очень) тонкости:
- Бот, токен и группа где этот бот есть — получить у оргов;
- Можно использовать какую-то библиотеку но в целом здесь хватит грамотного использования requests, так как вам не требуется сложного взаимодействия с пользователем. [Заготовка такого класса для бота](https://github.com/python-jitsu/airflow101/blob/master/snippets/w3-example-tg-bot-class.py);
- Для сохранения какой-то промежуточной информации используйте временный файл на диске;
- Для тестирования можно создать свою airtable базу/таблицу;
- Бот и группа общие для всех. Создавать отдельного бота чтобы отладить как это работает мы не рекомендуем: возможные незначительные технические трудности с доступами могут надолго отвлечь от задачи;
- Финальный датасет содержит следующие колонки: `chat_id`, `username`, `triggered_at`, `event_type`, ` reporter_name`. Их типы можно подсмотреть прямо в таблице;
- Подразумевается, что вы будете использовать самодельные операторы/сенсоры и опубликуете их как библиотеку на github;
- В данном задании можно захардкодить токен для доступа прям в коде вашего пайплайна. Если вы решите так сделать, то не выкладывайте код в публичный репозиторий.

## Файлы
- dags/
  - homework_3.py - основной код Airflow DAG для обработки событий в Telegram
- https://github.com/labdmitriy/telegram_interactions - библиотека с custom operators & sensors для работы с Telegram-ботом
  - Описание файлов библиотеки - в репозитории библиотеки

## Описание решения
- Отправка сообщения с кнопкой в Telegram-группу
  - TelegramSendMessageOperator
- Отслеживание событий нажатия кнопки, отправленной в рамках текущего запуска DAG
  - TelegramActionsIncrementSensor
  - В связи с возможными временными задержками между отработкой шагов 1 и 2 в рамках работы DAG, обрабатывается только первый элемент в списке полученных апдейтов
- Подготовка и сохранение информации по полученному событию в Airtable
  - TelegramSendMessageOperator
